{% extends "authentication/base.html" %}
{% load static %}

{% block title %}{{ post.title }} - KoraQuest{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row fade-in">
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-body p-0">
                    {% if post.image %}
                        <div class="product-gallery">
                            <!-- Main product image display -->
                            <div class="main-image-container">
                                <img src="{{ post.image.url }}" id="main-product-image" class="card-img-top rounded-top" alt="{{ post.title }}" style="max-height: 400px; object-fit: contain;">
                            </div>
                            
                            <!-- Auxiliary image thumbnails -->
                            {% if auxiliary_images %}
                            <div class="auxiliary-images-container p-2 d-flex justify-content-center">
                                <!-- Include main image as first thumbnail -->
                                <div class="thumbnail-item mx-1 active" data-img-url="{{ post.image.url }}">
                                    <img src="{{ post.image.url }}" alt="Main image" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;">
                                </div>
                                
                                {% for aux_image in auxiliary_images %}
                                <div class="thumbnail-item mx-1" data-img-url="{{ aux_image.image.url }}">
                                    <img src="{{ aux_image.image.url }}" alt="Product view {{ forloop.counter }}" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;">
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="bg-light p-5 text-center">
                            <i class="bi bi-image text-muted" style="font-size: 5rem;"></i>
                        </div>
                    {% endif %}
                    
                    <div class="p-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h2 class="card-title mb-0">{{ post.title }}</h2>
                            {% if is_owner %}
                            <a href="{% url 'edit_product' post.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil me-1"></i> Edit
                            </a>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex align-items-center gap-2 mb-4 mt-2">
                            <span class="badge bg-primary">{{ post.get_category_display }}</span>
                            <span class="badge bg-success">${{ post.price }}</span>
                            {% if post.inventory > 10 %}
                                <span class="badge bg-success">In Stock ({{ post.inventory }})</span>
                            {% elif post.inventory > 0 %}
                                <span class="badge bg-warning text-dark">Low Stock ({{ post.inventory }} left)</span>
                            {% else %}
                                <span class="badge bg-danger">Out of Stock</span>
                            {% endif %}
                        </div>
                        
                        <div class="mb-4">
                            <h5 class="mb-3">Description</h5>
                            <p class="card-text">{{ post.description|linebreaksbr }}</p>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                {% if post.user.profile_picture %}
                                    <img src="{{ post.user.profile_picture.url }}" class="rounded-circle me-2" alt="{{ post.user.username }}" style="width: 40px; height: 40px; object-fit: cover;">
                                {% else %}
                                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                        <span class="text-white">{{ post.user.first_name|first|upper }}{{ post.user.last_name|first|upper }}</span>
                                    </div>
                                {% endif %}
                                <div>
                                    <div class="fw-bold">{{ post.user.first_name }} {{ post.user.last_name }}</div>
                                    <small class="text-muted">@{{ post.user.username }}</small>
                                </div>
                            </div>
                            
                            <div>
                                <small class="text-muted">Posted {{ post.created_at|timesince }} ago</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Purchase Product</h5>
                </div>
                <div class="card-body">
                    {% if has_purchased %}
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill me-2"></i> You have already purchased this product.
                        </div>
                        <a href="{% url 'purchase_history' %}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-bag-check me-2"></i> View Your Purchases
                        </a>
                    {% elif is_owner %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle-fill me-2"></i> This is your own product.
                        </div>
                        <a href="{% url 'edit_product' post.id %}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-pencil me-2"></i> Edit Product
                        </a>
                    {% else %}
                        {% if post.price %}
                            {% if post.inventory > 0 %}
                            <div class="mb-3">
                                <h3 class="text-primary mb-3">${{ post.price }}</h3>
                                <p>Purchase this product securely with our payment system.</p>
                                
                                <!-- Buy Now Button to trigger modal -->
                                <button type="button" class="btn btn-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#paymentModal">
                                    <i class="bi bi-bag-plus me-2"></i> Buy Now
                                </button>
                                
                                <div class="text-center">
                                    <small class="text-muted">Secure payment â€¢ KoraQuest Protection</small>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i> This product is currently out of stock.
                            </div>
                            <button class="btn btn-outline-secondary w-100" disabled>
                                <i class="bi bi-bag-x me-2"></i> Out of Stock
                            </button>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            
            {% if not is_owner %}
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if is_owner %}
                        <a href="{% url 'edit_product' post.id %}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil me-2"></i> Edit Product
                        </a>
                        <hr>
                        {% endif %}
                        
                        {% if not is_owner %}
                        <button class="btn btn-outline-primary bookmark-btn" data-post-id="{{ post.id }}">
                            <i class="bi {% if is_bookmarked %}bi-bookmark-fill{% else %}bi-bookmark{% endif %} me-2"></i>
                            {% if is_bookmarked %}Saved{% else %}Save for Later{% endif %}
                        </button>
                        
                        <button class="btn btn-outline-primary like-btn" data-post-id="{{ post.id }}">
                            <i class="bi {% if user in post.likes.all %}bi-heart-fill{% else %}bi-heart{% endif %} me-2"></i>
                            Like ({{ post.total_likes }})
                        </button>
                        
                        <button class="btn btn-outline-primary share-btn">
                            <i class="bi bi-share me-2"></i> Share
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="paymentModalLabel">
                    <i class="bi bi-credit-card me-2"></i>Complete Your Purchase
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'purchase_product' post.id %}" id="paymentForm">
                    {% csrf_token %}
                    
                    <!-- Product Summary -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <img src="{{ post.image.url }}" alt="{{ post.title }}" class="img-fluid rounded">
                        </div>
                        <div class="col-md-8">
                            <h6 class="fw-bold">{{ post.title }}</h6>
                            <p class="text-muted mb-1">by {{ post.user.username }}</p>
                            <h5 class="text-primary">${{ post.price }} each</h5>
                            <span class="badge bg-success">{{ post.inventory }} in stock</span>
                        </div>
                    </div>

                    <!-- Payment Method Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-credit-card me-2"></i>Payment Method
                        </label>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="payment-option">
                                    <input type="radio" name="payment_method" value="momo" id="momo" class="form-check-input" checked>
                                    <label for="momo" class="payment-card">
                                        <div class="payment-card-content">
                                            <div class="payment-icon">
                                                <i class="bi bi-phone text-success fs-2"></i>
                                            </div>
                                            <div class="payment-details">
                                                <h6 class="mb-1">Mobile Money</h6>
                                                <small class="text-muted">Pay with MoMo</small>
                                            </div>
                                            <div class="payment-check">
                                                <i class="bi bi-check-circle-fill text-success"></i>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="payment-option">
                                    <input type="radio" name="payment_method" value="credit" id="credit" class="form-check-input">
                                    <label for="credit" class="payment-card">
                                        <div class="payment-card-content">
                                            <div class="payment-icon">
                                                <i class="bi bi-credit-card text-primary fs-2"></i>
                                            </div>
                                            <div class="payment-details">
                                                <h6 class="mb-1">Credit Card</h6>
                                                <small class="text-muted">Visa, MasterCard, etc.</small>
                                            </div>
                                            <div class="payment-check">
                                                <i class="bi bi-check-circle-fill text-success"></i>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quantity Selection -->
                    <div class="mb-4">
                        <label for="modal-quantity" class="form-label fw-bold">
                            <i class="bi bi-hash me-2"></i>Quantity
                        </label>
                        <div class="quantity-selector">
                            <button type="button" class="btn btn-outline-secondary" onclick="decreaseQuantity()">
                                <i class="bi bi-dash"></i>
                            </button>
                            <input type="number" class="form-control text-center" id="modal-quantity" name="quantity" 
                                   min="1" max="{{ post.inventory }}" value="1" required onchange="updatePricing()">
                            <button type="button" class="btn btn-outline-secondary" onclick="increaseQuantity()">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Delivery Method Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-truck me-2"></i>Delivery Method
                        </label>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="delivery-option">
                                    <input type="radio" name="delivery_method" value="pickup" id="modal-pickup" class="form-check-input" checked>
                                    <label for="modal-pickup" class="delivery-card">
                                        <div class="delivery-icon">
                                            <i class="bi bi-shop text-primary fs-3"></i>
                                        </div>
                                        <div class="delivery-details">
                                            <h6 class="mb-1">Pickup</h6>
                                            <small class="text-muted">Collect at KoraQuest</small>
                                            <div class="text-success fw-bold">FREE</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="delivery-option">
                                    <input type="radio" name="delivery_method" value="delivery" id="modal-delivery" class="form-check-input">
                                    <label for="modal-delivery" class="delivery-card">
                                        <div class="delivery-icon">
                                            <i class="bi bi-truck text-success fs-3"></i>
                                        </div>
                                        <div class="delivery-details">
                                            <h6 class="mb-1">Home Delivery</h6>
                                            <small class="text-muted">Delivered to your door</small>
                                            <div class="text-primary fw-bold">+$5.00</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Address (shown only when delivery is selected) -->
                    <div class="mb-4" id="modal-delivery-address-section" style="display: none;">
                        <label for="modal-delivery-address" class="form-label fw-bold">
                            <i class="bi bi-geo-alt me-2"></i>Delivery Address
                        </label>
                        <textarea class="form-control" id="modal-delivery-address" name="delivery_address" rows="3" 
                                  placeholder="Enter your full delivery address"></textarea>
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="modal-share-location-btn">
                                <i class="bi bi-geo-alt me-1"></i> Share My Location
                            </button>
                            <small class="text-muted d-block mt-1">This helps us provide accurate delivery service</small>
                        </div>
                        <input type="hidden" id="modal-delivery-latitude" name="delivery_latitude">
                        <input type="hidden" id="modal-delivery-longitude" name="delivery_longitude">
                    </div>

                    <!-- Price Breakdown -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-calculator me-2"></i>Order Summary
                            </h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Product Price:</span>
                                <span id="modal-product-total">${{ post.price }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2" id="modal-delivery-fee-row" style="display: none;">
                                <span>Delivery Fee:</span>
                                <span>$5.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Payment Processing:</span>
                                <span class="text-success">FREE</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fw-bold fs-5">
                                <span>Total:</span>
                                <span id="modal-total-price" class="text-primary">${{ post.price }}</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
                <button type="submit" form="paymentForm" class="btn btn-primary btn-lg">
                    <i class="bi bi-shield-check me-2"></i>Complete Purchase
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Payment Modal Styles */
.payment-option, .delivery-option {
    position: relative;
}

.payment-option input[type="radio"], .delivery-option input[type="radio"] {
    position: absolute;
    opacity: 0;
}

.payment-card, .delivery-card {
    display: block;
    padding: 20px;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    height: 100%;
}

.payment-card:hover, .delivery-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,123,255,0.15);
}

.payment-option input:checked + .payment-card,
.delivery-option input:checked + .delivery-card {
    border-color: #007bff;
    background: #f8f9ff;
    box-shadow: 0 4px 12px rgba(0,123,255,0.15);
}

.payment-card-content {
    display: flex;
    align-items: center;
    gap: 15px;
}

.payment-icon, .delivery-icon {
    flex-shrink: 0;
}

.payment-details, .delivery-details {
    flex-grow: 1;
    text-align: center;
}

.payment-check {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.payment-option input:checked + .payment-card .payment-check,
.delivery-option input:checked + .delivery-card .payment-check {
    opacity: 1;
}

.quantity-selector {
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 200px;
}

.quantity-selector .form-control {
    max-width: 80px;
}

.quantity-selector button {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
}
</style>

<script>
    // Handle bookmark functionality
    const bookmarkBtn = document.querySelector('.bookmark-btn');
    if (bookmarkBtn) {
        bookmarkBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const postId = this.getAttribute('data-post-id');
            const bookmarkBtn = this;
            
            fetch(`/auth/bookmark/${postId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.is_bookmarked || data.status === 'added') {
                    bookmarkBtn.innerHTML = '<i class="bi bi-bookmark-fill me-2"></i> Saved';
                } else {
                    bookmarkBtn.innerHTML = '<i class="bi bi-bookmark me-2"></i> Save for Later';
                }
            });
        });
    }
    
    // Handle like functionality
    const likeBtn = document.querySelector('.like-btn');
    if (likeBtn) {
        likeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const postId = this.getAttribute('data-post-id');
            const likeBtn = this;
            
            fetch(`/auth/like-post/${postId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.liked) {
                    likeBtn.innerHTML = `<i class="bi bi-heart-fill me-2"></i> Like (${data.total_likes})`;
                } else {
                    likeBtn.innerHTML = `<i class="bi bi-heart me-2"></i> Like (${data.total_likes})`;
                }
            });
        });
    }
    
    // Handle share functionality (dummy function for now)
    const shareBtn = document.querySelector('.share-btn');
    if (shareBtn) {
        shareBtn.addEventListener('click', function(e) {
            e.preventDefault();
            // Get current URL
            const url = window.location.href;
            
            // Copy to clipboard
            navigator.clipboard.writeText(url)
                .then(() => {
                    this.innerHTML = '<i class="bi bi-check-lg me-2"></i> Copied!';
                    setTimeout(() => {
                        this.innerHTML = '<i class="bi bi-share me-2"></i> Share';
                    }, 2000);
                });
        });
    }

    // Payment Modal Functionality
    const productPrice = {{ post.price }};
    const deliveryFee = 5.00;
    
    // Quantity controls
    function increaseQuantity() {
        const quantityInput = document.getElementById('modal-quantity');
        const maxQuantity = parseInt(quantityInput.getAttribute('max'));
        const currentQuantity = parseInt(quantityInput.value);
        
        if (currentQuantity < maxQuantity) {
            quantityInput.value = currentQuantity + 1;
            updatePricing();
        }
    }
    
    function decreaseQuantity() {
        const quantityInput = document.getElementById('modal-quantity');
        const currentQuantity = parseInt(quantityInput.value);
        
        if (currentQuantity > 1) {
            quantityInput.value = currentQuantity - 1;
            updatePricing();
        }
    }
    
    // Update pricing based on quantity and delivery method
    function updatePricing() {
        const quantity = parseInt(document.getElementById('modal-quantity').value) || 1;
        const deliveryMethod = document.querySelector('input[name="delivery_method"]:checked').value;
        
        const subtotal = productPrice * quantity;
        const totalDeliveryFee = deliveryMethod === 'delivery' ? deliveryFee : 0;
        const total = subtotal + totalDeliveryFee;
        
        // Update display
        document.getElementById('modal-product-total').textContent = '$' + subtotal.toFixed(2);
        document.getElementById('modal-total-price').textContent = '$' + total.toFixed(2);
        
        // Show/hide delivery fee row
        const deliveryFeeRow = document.getElementById('modal-delivery-fee-row');
        const deliveryAddressSection = document.getElementById('modal-delivery-address-section');
        
        if (deliveryMethod === 'delivery') {
            deliveryFeeRow.style.display = 'flex';
            deliveryAddressSection.style.display = 'block';
            document.getElementById('modal-delivery-address').setAttribute('required', 'required');
        } else {
            deliveryFeeRow.style.display = 'none';
            deliveryAddressSection.style.display = 'none';
            document.getElementById('modal-delivery-address').removeAttribute('required');
        }
    }
    
    // Handle delivery method changes
    document.addEventListener('DOMContentLoaded', function() {
        const deliveryRadios = document.querySelectorAll('input[name="delivery_method"]');
        deliveryRadios.forEach(radio => {
            radio.addEventListener('change', updatePricing);
        });
        
        // Location sharing functionality
        const shareLocationBtn = document.getElementById('modal-share-location-btn');
        if (shareLocationBtn) {
            shareLocationBtn.addEventListener('click', function() {
                const btn = this;
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<i class="bi bi-geo-alt me-1"></i> Getting Location...';
                btn.disabled = true;
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            // Store coordinates in hidden fields
                            document.getElementById('modal-delivery-latitude').value = lat;
                            document.getElementById('modal-delivery-longitude').value = lng;
                            
                            // Update address field
                            const addressField = document.getElementById('modal-delivery-address');
                            if (!addressField.value.trim()) {
                                addressField.value = `Location shared (${lat.toFixed(6)}, ${lng.toFixed(6)})`;
                            }
                            
                            btn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Location Shared';
                            btn.classList.remove('btn-outline-primary');
                            btn.classList.add('btn-success');
                            
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.classList.remove('btn-success');
                                btn.classList.add('btn-outline-primary');
                                btn.disabled = false;
                            }, 3000);
                        },
                        function(error) {
                            console.error('Location error:', error);
                            btn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i> Location Failed';
                            btn.classList.remove('btn-outline-primary');
                            btn.classList.add('btn-warning');
                            
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.classList.remove('btn-warning');
                                btn.classList.add('btn-outline-primary');
                                btn.disabled = false;
                            }, 3000);
                        }
                    );
                } else {
                    btn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i> Not Supported';
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-warning');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('btn-warning');
                        btn.classList.add('btn-outline-primary');
                        btn.disabled = false;
                    }, 3000);
                }
            });
        }
        
        // Initialize pricing
        updatePricing();
    });
</script>
{% endblock %}
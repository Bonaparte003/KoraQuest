{% extends "authentication/base.html" %}
{% load static %}

{% block title %}{% if view_type == 'jobs' %}Job Board{% else %}Market{% endif %} - KoraQuest{% endblock %}

{% block extra_css %}
<style>
    /* Post card hover effect */
    .card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    
    /* Card link styling */
    .card-link {
        position: relative;
        z-index: 1;
    }
    
    /* Button inside card should have a higher z-index */
    .card .btn {
        position: relative;
        z-index: 2;
    }
    
    /* Post badges */
    .post-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        z-index: 2;
    }
    
    .badge-featured {
        background-color: var(--kora-blue);
        color: white;
    }
    
    .badge-new {
        background-color: #4caf50;
        color: white;
    }
    
    /* Card image container and overlay */
    .card-img-container {
        position: relative;
    }
    
    .card-img-overlay {
        position: absolute;
        top: 0;
        right: 0;
        padding: 0.5rem;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .card:hover .card-img-overlay {
        opacity: 1;
    }
    
    /* User avatar styles */
    .avatar {
        width: 32px;
        height: 32px;
        overflow: hidden;
    }
    
    .avatar-sm {
        width: 32px;
        height: 32px;
    }
    
    /* Loading spinner */
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: var(--kora-blue);
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Search bar and filters in one row -->
    <div class="row mb-4 fade-in">
        <div class="col-md-8">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control border-start-0 ps-0" placeholder="{% if view_type == 'jobs' %}Search for jobs...{% else %}Search for products...{% endif %}">
                <button class="btn btn-primary" type="button">Search</button>
            </div>
        </div>
        <div class="col-md-4 d-flex justify-content-end align-items-center mt-3 mt-md-0">
            <div class="dropdown me-2">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-funnel"></i> Filter
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="filterDropdown">
                    <li><a class="dropdown-item" href="#">Most Recent</a></li>
                    <li><a class="dropdown-item" href="#">Most Popular</a></li>
                    <li><a class="dropdown-item" href="#">Following</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#">All Posts</a></li>
                </ul>
            </div>
            {% if user.is_vendor_role or user.is_hiring_company_role %}
            <a href="{% url 'create_post' %}" class="btn btn-gradient">
                <i class="bi bi-plus-lg"></i> Create Post
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Page Title and Categories -->
    <div class="row mb-4 fade-in" style="animation-delay: 0.1s;">
        <div class="col-12 mb-3">
            <h2 class="fw-bold">{% if view_type == 'jobs' %}Job Board{% else %}Market{% endif %}</h2>
            <p class="text-muted">{% if view_type == 'jobs' %}Find career opportunities from hiring companies{% else %}Discover products from our community of vendors{% endif %}</p>
        </div>
        <div class="col-12">
            <div class="d-flex justify-content-start flex-wrap gap-2 overflow-auto py-2">
                {% if view_type == 'jobs' %}
                    <!-- Job categories -->
                    <button class="btn btn-primary rounded-pill active">All Jobs</button>
                    <button class="btn btn-outline-primary rounded-pill">Full-time</button>
                    <button class="btn btn-outline-primary rounded-pill">Part-time</button>
                    <button class="btn btn-outline-primary rounded-pill">Remote</button>
                    <button class="btn btn-outline-primary rounded-pill">Contract</button>
                    <button class="btn btn-outline-primary rounded-pill">Freelance</button>
                    <button class="btn btn-outline-primary rounded-pill">Internship</button>
                {% else %}
                    <!-- Product categories -->
                    <button class="btn btn-primary rounded-pill active">All Products</button>
                    <button class="btn btn-outline-primary rounded-pill">Electronics</button>
                    <button class="btn btn-outline-primary rounded-pill">Clothing</button>
                    <button class="btn btn-outline-primary rounded-pill">Home & Kitchen</button>
                    <button class="btn btn-outline-primary rounded-pill">Beauty</button>
                    <button class="btn btn-outline-primary rounded-pill">Health</button>
                    <button class="btn btn-outline-primary rounded-pill">Books & Media</button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Pinterest-like masonry layout -->
    <div class="row slide-up" id="masonry-container" style="animation-delay: 0.2s;">
        {% if posts %}
            {% for post in posts %}
                <div class="col-sm-6 col-md-4 col-lg-3 mb-4 masonry-item">
                    <div class="card shadow-sm h-100">
                        <a href="{% url 'post_detail' post.id %}" class="text-decoration-none text-dark card-link">
                        {% if post.image %}
                            <div class="card-img-container">
                                {% if forloop.counter == 1 %}
                                <span class="post-badge badge-featured">Featured</span>
                                {% elif forloop.counter < 4 %}
                                <span class="post-badge badge-new">New</span>
                                {% endif %}
                                <img src="{{ post.image.url }}" class="card-img-top" alt="{{ post.title }}" loading="lazy">
                                <div class="card-img-overlay">
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-light like-btn" data-post-id="{{ post.id }}">
                                            <i class="bi {% if user in post.likes.all %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-light bookmark-btn" data-post-id="{{ post.id }}">
                                            <i class="bi {% if post.id in bookmarked_posts %}bi-bookmark-fill{% else %}bi-bookmark{% endif %}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-light">
                                            <i class="bi bi-share"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="bg-light p-5 text-center">
                                <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                            </div>
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ post.title }}</h5>
                            <p class="card-text text-muted">{{ post.description|truncatechars:100 }}</p>
                            {% if post.post_type == 'product' %}
                                <p class="fw-bold text-primary mb-2">${{ post.price }}</p>
                                <div class="badge bg-primary mb-3">{{ post.category }}</div>
                            {% else %}
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <div class="badge bg-info">{{ post.job_type }}</div>
                                    <div class="badge bg-secondary">{{ post.job_location }}</div>
                                    {% if post.salary_range %}
                                        <div class="badge bg-success">{{ post.salary_range }}</div>
                                    {% endif %}
                                </div>
                            {% endif %}
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="d-flex align-items-center">
                                    {% if post.user.profile_picture %}
                                        <img src="{{ post.user.profile_picture.url }}" class="avatar avatar-sm me-2 rounded-circle" alt="{{ post.user.username }}" style="width: 32px; height: 32px; object-fit: cover;">
                                    {% else %}
                                        <div class="avatar avatar-sm me-2 rounded-circle bg-primary d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                            <span class="text-white" style="font-size: 0.8rem;">{{ post.user.first_name|first|upper }}{{ post.user.last_name|first|upper }}</span>
                                        </div>
                                    {% endif %}
                                    <span class="small fw-medium">{{ post.user.username }}</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-primary rounded-pill like-btn" data-post-id="{{ post.id }}">
                                        <i class="bi {% if user in post.likes.all %}bi-heart-fill{% else %}bi-heart{% endif %}"></i> 
                                        <span class="like-count">{{ post.total_likes }}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-white border-top-0 text-end">
                            <small class="text-muted">{{ post.created_at|timesince }} ago</small>
                            {% if post.post_type == 'product' %}
                                <span class="float-start badge bg-primary rounded-pill">
                                    <i class="bi bi-cart me-1"></i> Buy Now
                                </span>
                            {% else %}
                                <span class="float-start badge bg-success rounded-pill">
                                    <i class="bi bi-briefcase me-1"></i> Apply Now
                                </span>
                            {% endif %}
                        </div>
                        </a>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12 text-center py-5">
                <div class="display-6 text-muted mb-3">
                    {% if view_type == 'jobs' %}No job postings available{% else %}No products available{% endif %}
                </div>
                <p class="lead mb-4">
                    {% if view_type == 'jobs' %}
                        {% if user.is_hiring_company_role %}
                            Be the first to post a job opening!
                        {% else %}
                            Upgrade your account to hiring company status to post jobs.
                        {% endif %}
                    {% else %}
                        {% if user.is_vendor_role %}
                            Be the first to list a product for sale!
                        {% else %}
                            Upgrade your account to vendor status to sell products.
                        {% endif %}
                    {% endif %}
                </p>
                <div class="d-inline-block mb-4">
                    <img src="{% static 'img/empty-state.svg' %}" alt="No content" onerror="this.style.display='none'" style="max-width: 300px;">
                </div>
                <div>
                    {% if user.is_vendor_role or user.is_hiring_company_role %}
                    <a href="{% url 'create_post' %}" class="btn btn-gradient btn-lg">
                        <i class="bi bi-plus-lg"></i> Create Your First Post
                    </a>
                    {% elif not user.is_vendor_role and not user.is_hiring_company_role and not user.is_freelancer_role %}
                    <div class="d-flex justify-content-center gap-3">
                        <a href="{% url 'user_settings' %}#upgrade" class="btn btn-outline-primary btn-lg">
                            <i class="bi bi-arrow-up-circle"></i> Upgrade Account
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
    
    <!-- Loading spinner -->
    <div class="text-center my-5 d-none" id="loading">
        <div class="loading-spinner"></div>
        <p class="mt-3 text-muted">Loading more posts...</p>
    </div>
    
    <!-- Load more button -->
    <div class="text-center mb-5 mt-3 fade-in" style="animation-delay: 0.3s;">
        <button class="btn btn-outline-primary px-4 py-2" id="loadMoreBtn">
            <i class="bi bi-arrow-down-circle"></i> Load More
        </button>
    </div>
</div>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D" crossorigin="anonymous" async></script>
<script>
    // Initialize Masonry layout after page load
    window.addEventListener('load', function() {
        var grid = document.querySelector('#masonry-container');
        var masonry = new Masonry(grid, {
            itemSelector: '.masonry-item',
            percentPosition: true,
            transitionDuration: '0.3s'
        });
        
        // Reapply masonry layout after images load
        var images = document.querySelectorAll('.card-img-top');
        images.forEach(function(img) {
            if (img.complete) {
                masonry.layout();
            } else {
                img.addEventListener('load', function() {
                    masonry.layout();
                });
            }
        });
        
        // Simulate loading more posts
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const loading = document.getElementById('loading');
        
        loadMoreBtn.addEventListener('click', function() {
            loadMoreBtn.style.display = 'none';
            loading.classList.remove('d-none');
            
            // Simulate loading delay
            setTimeout(function() {
                loading.classList.add('d-none');
                loadMoreBtn.style.display = 'inline-block';
                // In a real app, you would fetch more posts from the server here
            }, 2000);
        });
    });
    
    // Handle like functionality with AJAX
    document.querySelectorAll('.like-btn').forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation(); // Prevent card link click
            const postId = this.getAttribute('data-post-id');
            const likeButtons = document.querySelectorAll(`.like-btn[data-post-id="${postId}"]`);
            
            // Add a quick visual feedback
            this.classList.add('animate__animated', 'animate__heartBeat');
            
            fetch(`/auth/like-post/${postId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                likeButtons.forEach(function(btn) {
                    const heartIcon = btn.querySelector('i');
                    const likeCount = btn.querySelector('.like-count');
                    
                    if (data.liked) {
                        heartIcon.classList.remove('bi-heart');
                        heartIcon.classList.add('bi-heart-fill');
                    } else {
                        heartIcon.classList.remove('bi-heart-fill');
                        heartIcon.classList.add('bi-heart');
                    }
                    
                    if (likeCount) {
                        likeCount.textContent = data.total_likes;
                    }
                });
                
                // Remove the animation class after animation completes
                setTimeout(() => {
                    this.classList.remove('animate__animated', 'animate__heartBeat');
                }, 1000);
            });
        });
    });
    
    // Handle bookmark functionality with AJAX
    document.querySelectorAll('.bookmark-btn').forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation(); // Prevent card link click
            const postId = this.getAttribute('data-post-id');
            const bookmarkButtons = document.querySelectorAll(`.bookmark-btn[data-post-id="${postId}"]`);
            
            // Add a quick visual feedback
            this.classList.add('animate__animated', 'animate__bounceIn');
            
            fetch(`/auth/bookmark/${postId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => {
                console.log('Bookmark response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Bookmark response data:', data);
                bookmarkButtons.forEach(function(btn) {
                    const bookmarkIcon = btn.querySelector('i');
                    
                    if (data.is_bookmarked || data.status === 'added') {
                        bookmarkIcon.classList.remove('bi-bookmark');
                        bookmarkIcon.classList.add('bi-bookmark-fill');
                    } else {
                        bookmarkIcon.classList.remove('bi-bookmark-fill');
                        bookmarkIcon.classList.add('bi-bookmark');
                    }
                });
                
                // Remove the animation class after animation completes
                setTimeout(() => {
                    this.classList.remove('animate__animated', 'animate__bounceIn');
                }, 1000);
            })
            .catch(error => {
                console.error('Error toggling bookmark:', error);
            });
        });
    });
    
    // Stop event propagation for bookmark and share buttons
    document.querySelectorAll('.card-img-overlay .btn').forEach(function(button) {
        if (!button.classList.contains('like-btn') && !button.classList.contains('bookmark-btn')) { // Already handled like and bookmark buttons
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation(); // Prevent card link click
                // Handle other button functionalities if needed
            });
        }
    });
    
    // Filter buttons highlight
    document.querySelectorAll('.btn-outline-primary').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelector('.btn-primary.rounded-pill.active').classList.remove('active');
            document.querySelector('.btn-primary.rounded-pill').classList.replace('btn-primary', 'btn-outline-primary');
            this.classList.replace('btn-outline-primary', 'btn-primary');
            this.classList.add('active');
        });
    });
    
    // Test button for bookmarking
    const bookmarkTestBtn = document.getElementById('testBookmarkBtn');
    const testResults = document.getElementById('testResults');
    
    if (bookmarkTestBtn) {
        bookmarkTestBtn.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            testResults.innerHTML = `<p>Testing bookmark for post ID: ${postId}...</p>`;
            
            fetch(`/auth/bookmark/${postId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => {
                testResults.innerHTML += `<p>Response status: ${response.status}</p>`;
                return response.json();
            })
            .then(data => {
                testResults.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            })
            .catch(error => {
                testResults.innerHTML += `<p class="text-danger">Error: ${error.message}</p>`;
            });
        });
    }
</script>
{% endblock extra_js %}
{% endblock content %}
{% extends "authentication/base.html" %}
{% load static %}

{% block title %}Take Quiz: {{ quiz.title }} - KoraQuest{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row mb-4 fade-in">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-1">{{ quiz.title }}</h2>
                <p class="text-muted">Assessment for: {{ quiz.job.title }}</p>
            </div>
            <div id="timerContainer" class="d-flex align-items-center">
                <span class="badge bg-primary p-2 me-2">Time Remaining:</span>
                <span id="timer" class="fw-bold" style="font-size: 1.2rem;">00:00:00</span>
            </div>
        </div>
    </div>
    
    <div class="row mb-4 fade-in">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Assessment Instructions</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <p>{{ quiz.description }}</p>
                    </div>
                    
                    <div class="alert alert-info">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="bi bi-info-circle-fill fs-4"></i>
                            </div>
                            <div>
                                <h6 class="alert-heading">Important Notes</h6>
                                <ul class="mb-0">
                                    <li>You have {{ quiz.time_limit_minutes }} minutes to complete this assessment</li>
                                    <li>You need {{ quiz.passing_score }}% to pass this assessment</li>
                                    <li>Answer all questions to the best of your ability</li>
                                    <li>Do not refresh the page or navigate away during the assessment</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <form method="POST" id="quizForm">
                {% csrf_token %}
                
                {% for question in questions %}
                <div class="card shadow-sm mb-4 question-card" id="question-{{ forloop.counter }}">
                    <div class="card-header bg-white d-flex justify-content-between">
                        <h5 class="mb-0">Question {{ forloop.counter }}</h5>
                        <span class="badge bg-primary">{{ question.points }} points</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6 class="fw-bold">{{ question.question_text }}</h6>
                        </div>
                        
                        {% if question.code_snippet %}
                        <div class="mb-3">
                            <div class="bg-light p-3 rounded">
                                <pre class="mb-0"><code>{{ question.code_snippet }}</code></pre>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if question.question_type == 'multiple_choice' %}
                        <div class="mb-3">
                            <div class="list-group">
                                {% for option in question.options.all %}
                                <label class="list-group-item">
                                    <div class="d-flex align-items-center">
                                        <input class="form-check-input me-3" type="radio" name="question_{{ question.id }}" value="{{ option.id }}" required>
                                        <span>{{ option.option_text }}</span>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% elif question.question_type == 'text' %}
                        <div class="mb-3">
                            <textarea class="form-control" name="question_{{ question.id }}" rows="4" placeholder="Type your answer here..." required></textarea>
                        </div>
                        {% elif question.question_type == 'code' %}
                        <div class="mb-3">
                            <textarea class="form-control font-monospace" name="question_{{ question.id }}" rows="10" placeholder="Write your code here..." required></textarea>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <button type="button" id="prevBtn" class="btn btn-outline-secondary" onclick="navigateQuestion(-1)" disabled>
                                <i class="bi bi-arrow-left me-1"></i> Previous
                            </button>
                            <div>
                                <span id="questionCounter">Question 1 of {{ questions.count }}</span>
                            </div>
                            <div>
                                <button type="button" id="nextBtn" class="btn btn-outline-primary me-2" onclick="navigateQuestion(1)">
                                    Next <i class="bi bi-arrow-right ms-1"></i>
                                </button>
                                <button type="submit" id="submitBtn" class="btn btn-primary" style="display: none;">
                                    Submit Assessment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Quiz Progress</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>Questions Answered:</span>
                        <span id="answeredCounter">0/{{ questions.count }}</span>
                    </div>
                    
                    <div class="progress mb-4">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    
                    <div class="question-navigator">
                        <div class="d-flex flex-wrap gap-2">
                            {% for question in questions %}
                            <button type="button" class="btn btn-outline-secondary question-nav-btn" onclick="goToQuestion({{ forloop.counter }})" data-question="{{ forloop.counter }}">
                                {{ forloop.counter }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Read each question carefully before answering
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            You can navigate between questions
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Manage your time wisely
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Submit when you've answered all questions
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables to track quiz state
    let currentQuestionIndex = 1;
    const totalQuestions = {{ questions.count }};
    let answeredQuestions = 0;
    let timeLeft = {{ quiz.time_limit_minutes }} * 60; // in seconds
    
    // Initialize quiz
    document.addEventListener('DOMContentLoaded', function() {
        // Show only the first question initially
        showCurrentQuestion();
        
        // Start the timer
        startTimer();
        
        // Track form inputs to update progress
        setupInputTracking();
        
        // Set up form submission handling
        document.getElementById('quizForm').addEventListener('submit', function(e) {
            if (!confirmSubmission()) {
                e.preventDefault();
            }
        });
    });
    
    // Show only the current question
    function showCurrentQuestion() {
        // Hide all questions
        const questions = document.querySelectorAll('.question-card');
        questions.forEach(question => {
            question.style.display = 'none';
        });
        
        // Show current question
        const currentQuestion = document.getElementById(`question-${currentQuestionIndex}`);
        if (currentQuestion) {
            currentQuestion.style.display = 'block';
        }
        
        // Update question counter
        document.getElementById('questionCounter').textContent = `Question ${currentQuestionIndex} of ${totalQuestions}`;
        
        // Update navigation buttons
        document.getElementById('prevBtn').disabled = (currentQuestionIndex === 1);
        
        if (currentQuestionIndex === totalQuestions) {
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'inline-block';
        } else {
            document.getElementById('nextBtn').style.display = 'inline-block';
            document.getElementById('submitBtn').style.display = 'none';
        }
        
        // Update question navigator buttons
        const navButtons = document.querySelectorAll('.question-nav-btn');
        navButtons.forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-secondary');
            
            if (parseInt(btn.getAttribute('data-question')) === currentQuestionIndex) {
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-primary');
            }
        });
    }
    
    // Navigate between questions
    function navigateQuestion(direction) {
        const newIndex = currentQuestionIndex + direction;
        if (newIndex >= 1 && newIndex <= totalQuestions) {
            currentQuestionIndex = newIndex;
            showCurrentQuestion();
        }
    }
    
    // Go to a specific question
    function goToQuestion(questionNumber) {
        if (questionNumber >= 1 && questionNumber <= totalQuestions) {
            currentQuestionIndex = questionNumber;
            showCurrentQuestion();
        }
    }
    
    // Track form inputs to update progress
    function setupInputTracking() {
        const questions = document.querySelectorAll('.question-card');
        questions.forEach((question, index) => {
            const inputs = question.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    updateQuestionStatus(index + 1);
                });
                
                if (input.tagName === 'TEXTAREA') {
                    input.addEventListener('input', function() {
                        if (this.value.trim() !== '') {
                            updateQuestionStatus(index + 1);
                        } else {
                            updateQuestionStatus(index + 1, false);
                        }
                    });
                }
            });
        });
    }
    
    // Update the status of a question (answered or not)
    function updateQuestionStatus(questionNumber, isAnswered = true) {
        const navButton = document.querySelector(`.question-nav-btn[data-question="${questionNumber}"]`);
        
        if (isAnswered) {
            if (!navButton.classList.contains('btn-success')) {
                navButton.classList.remove('btn-outline-secondary', 'btn-primary');
                navButton.classList.add('btn-success');
                answeredQuestions++;
            }
        } else {
            if (navButton.classList.contains('btn-success')) {
                navButton.classList.remove('btn-success');
                navButton.classList.add('btn-outline-secondary');
                answeredQuestions--;
            }
        }
        
        // Update progress
        updateProgress();
    }
    
    // Update progress indicators
    function updateProgress() {
        const progressPercent = Math.round((answeredQuestions / totalQuestions) * 100);
        document.getElementById('answeredCounter').textContent = `${answeredQuestions}/${totalQuestions}`;
        
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = `${progressPercent}%`;
        progressBar.textContent = `${progressPercent}%`;
        progressBar.setAttribute('aria-valuenow', progressPercent);
        
        // Show submit button if all questions answered
        if (answeredQuestions === totalQuestions) {
            document.getElementById('submitBtn').classList.add('btn-success');
        } else {
            document.getElementById('submitBtn').classList.remove('btn-success');
        }
    }
    
    // Timer functionality
    function startTimer() {
        const timerElement = document.getElementById('timer');
        const timerContainer = document.getElementById('timerContainer');
        
        const timerInterval = setInterval(() => {
            timeLeft--;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                // Auto-submit when time expires
                document.getElementById('quizForm').submit();
            }
            
            // Format time
            const hours = Math.floor(timeLeft / 3600);
            const minutes = Math.floor((timeLeft % 3600) / 60);
            const seconds = timeLeft % 60;
            
            timerElement.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            // Change color when time is running low
            if (timeLeft < 60) {
                timerContainer.classList.add('text-danger');
                timerElement.classList.add('text-danger');
            } else if (timeLeft < 300) { // 5 minutes
                timerContainer.classList.add('text-warning');
                timerElement.classList.add('text-warning');
            }
        }, 1000);
    }
    
    // Confirm submission
    function confirmSubmission() {
        const unansweredQuestions = totalQuestions - answeredQuestions;
        
        if (unansweredQuestions > 0) {
            return confirm(`You have ${unansweredQuestions} unanswered question(s). Are you sure you want to submit the quiz?`);
        }
        
        return true;
    }
</script>
{% endblock %} 
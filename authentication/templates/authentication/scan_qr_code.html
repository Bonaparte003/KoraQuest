{% extends "authentication/base.html" %}
{% load static %}

{% block title %}QR Code Scanner{% endblock %}

{% block extra_head %}
<style>
    ::-webkit-scrollbar {
        display: none;
    }
    
    /* Main container styles */
    .scanner-container {
        background: white;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .scanner-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .scanner-header h1 {
        font-size: 2rem;
        color: #333;
        margin: 0;
    }

    /* Camera section styles */
    .camera-section {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
    }

    #scanner-container {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        position: relative;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
    }

    #qr-video {
        width: 100%;
        max-width: 600px;
        border-radius: 8px;
        transform: scaleX(-1); /* Mirror the video feed for selfie mode */
    }

    .scan-region-highlight {
        border: 2px solid #007bff;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 200px;
        border-radius: 8px;
        pointer-events: none;
        z-index: 1;
    }

    .scan-region-highlight::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: #00ff00;
        animation: scan 2s linear infinite;
    }

    @keyframes scan {
        0% { transform: translateY(0); }
        50% { transform: translateY(200px); }
        100% { transform: translateY(0); }
    }

    /* Button styles */
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    /* Status indicators */
    .library-status {
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .library-status.loading {
        background: #e9ecef;
        color: #495057;
    }

    .library-status.success {
        background: #d4edda;
        color: #155724;
    }

    .library-status.error {
        background: #f8d7da;
        color: #721c24;
    }

    /* Manual QR input section */
    .qr-input-section {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 8px;
        margin-top: 2rem;
    }

    .qr-input-section h3 {
        margin-bottom: 1rem;
        color: #333;
    }

    .qr-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        margin-bottom: 1rem;
        font-size: 1rem;
    }

    /* Loading spinner */
    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Debug section */
    .debug-info {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        font-family: monospace;
        max-height: 200px;
        overflow-y: auto;
    }

    /* Unified Popup Styles */
    .popup-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .popup-container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 2rem;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .popup-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .popup-title {
        font-size: 1.5rem;
        color: #333;
        margin: 0 0 0.5rem 0;
    }

    .popup-subtitle {
        color: #6c757d;
        margin: 0;
    }

    .popup-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #6c757d;
        cursor: pointer;
        padding: 0.5rem;
        line-height: 1;
    }

    .popup-close:hover {
        color: #343a40;
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        color: #495057;
        font-weight: 500;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #ced4da;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }

    .form-input:focus {
        border-color: #007bff;
        outline: none;
    }

    /* OTP Input Styles */
    .otp-group {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        margin: 2rem 0;
    }

    .otp-input {
        width: 3rem;
        height: 3rem;
        text-align: center;
        font-size: 1.25rem;
        border: 2px solid #ced4da;
        border-radius: 6px;
        transition: all 0.3s ease;
    }

    .otp-input:focus {
        border-color: #007bff;
        outline: none;
    }

    /* Purchase List Styles */
    .purchase-list {
        max-height: 300px;
        overflow-y: auto;
        margin: 1rem 0;
    }

    .purchase-item {
        padding: 1rem;
        border: 1px solid #ced4da;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .purchase-item:hover {
        background: #f8f9fa;
        border-color: #007bff;
    }

    .purchase-item.selected {
        background: #e7f5ff;
        border-color: #007bff;
    }

    /* Error Message Styles */
    .error-message {
        color: #dc3545;
        background: #f8d7da;
        padding: 0.75rem;
        border-radius: 4px;
        margin: 1rem 0;
        display: none;
    }

    /* Timer Styles */
    .timer {
        text-align: center;
        color: #6c757d;
        margin: 1rem 0;
    }

    /* Popup Footer */
    .popup-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        gap: 1rem;
    }

    .popup-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        border: none;
    }

    .popup-btn-primary {
        background: #007bff;
        color: white;
    }

    .popup-btn-primary:hover {
        background: #0056b3;
    }

    .popup-btn-secondary {
        background: #6c757d;
        color: white;
    }

    .popup-btn-secondary:hover {
        background: #5a6268;
    }

    .popup-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* QR Scanner Enhancements */
    #qr-reader {
        position: relative;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
    }

    #qr-reader video {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover;
        border-radius: 12px;
    }

    #qr-reader__scan_region {
        position: relative;
    }

    #qr-reader__scan_region img {
        display: none; /* Hide the default scan region image */
    }

    .scan-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 250px;
        height: 250px;
        background: transparent;
        border: 2px solid #fff;
        border-radius: 20px;
        box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.3);
        animation: scan 3s ease-in-out infinite;
    }

    .scan-indicator::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: #00ff00;
        animation: scanline 2s linear infinite;
    }

    @keyframes scan {
        0% {
            border-color: rgba(255, 255, 255, 0.5);
        }
        50% {
            border-color: rgba(255, 255, 255, 1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5),
                        0 0 0 4000px rgba(0, 0, 0, 0.3);
        }
        100% {
            border-color: rgba(255, 255, 255, 0.5);
        }
    }

    @keyframes scanline {
        0% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(250px);
        }
        100% {
            transform: translateY(0);
        }
    }

    /* Enhanced Camera Status */
    .camera-status {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        z-index: 1000;
        transition: all 0.3s ease;
    }

    .camera-status.success {
        background: rgba(40, 167, 69, 0.9);
    }

    .camera-status.error {
        background: rgba(220, 53, 69, 0.9);
    }
</style>
{% endblock %}

{% block content %}
<div class="scanner-container">
    <div class="scanner-header">
        <h1>QR Code Scanner</h1>
        <button id="toggle-debug" class="btn">Show Debug</button>
    </div>

    <div id="debug-info" class="debug-info" style="display: none;">
        <div id="debug-log"></div>
    </div>

    <div class="scanner-section">
        <div id="library-status" class="library-status loading">
            Loading QR scanner...
        </div>

        <div id="camera-status" class="library-status" style="display: none;"></div>

        <div class="camera-section">
            <div id="scanner-container" style="position: relative; display: none;">
                <video id="qr-video" autoplay playsinline style="width: 100%; max-width: 600px; border-radius: 8px;"></video>
                <div class="scan-region-highlight"></div>
                <button id="stop-scanning-btn" class="btn btn-danger" style="position: absolute; top: 10px; right: 10px; display: none;">
                    Stop Scanner
                </button>
            </div>
            <button id="start-scanning-btn" class="btn btn-primary">
                <span class="loading-spinner" style="display: none;"></span>
                Launch Camera
            </button>
        </div>

        <div id="error-section" class="error-section">
            <div id="error-message"></div>
        </div>

        <div class="qr-input-section">
            <h3>Manual QR Code Entry</h3>
            <form id="manual-qr-form">
                <input type="text" id="manual-qr-input" class="qr-input" placeholder="Enter QR code data manually">
                <button type="submit" id="manual-submit-btn" class="btn btn-primary">
                    <div class="loading-spinner" style="display: none;"></div>
                    Submit
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Unified Dynamic Popup -->
<div id="dynamic-popup" class="popup-overlay">
    <div class="popup-container">
        <button class="popup-close" data-action="close">&times;</button>
        
        <!-- Purchase Selection View -->
        <div id="purchase-view" class="popup-view" style="display: none;">
            <div class="popup-header">
                <h2 class="popup-title">Select Purchase</h2>
                <p class="popup-subtitle">Please select the purchase you want to verify</p>
            </div>
            <div id="purchase-loading" style="text-align: center;">
                <div class="loading-spinner"></div>
                Loading purchases...
            </div>
            <div id="purchase-empty" style="display: none;">
                No purchases found for this QR code.
            </div>
            <div id="purchase-list" class="purchase-list"></div>
            <div class="popup-footer">
                <button class="popup-btn popup-btn-secondary" data-action="close">Cancel</button>
                <button id="confirm-purchase-btn" class="popup-btn popup-btn-primary" disabled>Confirm Selection</button>
            </div>
        </div>

        <!-- Authentication View -->
        <div id="auth-view" class="popup-view" style="display: none;">
            <div class="popup-header">
                <h2 class="popup-title">Verify Identity</h2>
                <p class="popup-subtitle">Please enter your credentials to verify your identity</p>
            </div>
            <div class="form-group">
                <label class="form-label" for="auth-username">Username</label>
                <input type="text" id="auth-username" class="form-input" placeholder="Enter your username">
            </div>
            <div class="form-group">
                <label class="form-label" for="auth-password">Password</label>
                <input type="password" id="auth-password" class="form-input" placeholder="Enter your password">
            </div>
            <div id="auth-error" class="error-message"></div>
            <div class="popup-footer">
                <button class="popup-btn popup-btn-secondary" data-action="close">Cancel</button>
                <button id="verify-credentials-btn" class="popup-btn popup-btn-primary">Verify</button>
            </div>
        </div>

        <!-- OTP View -->
        <div id="otp-view" class="popup-view" style="display: none;">
            <div class="popup-header">
                <h2 class="popup-title">Enter OTP</h2>
                <p class="popup-subtitle">A one-time password has been sent to <span id="buyer-email"></span></p>
            </div>
            <div class="otp-group">
                <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
            </div>
            <div class="timer">
                Time remaining: <span id="timer-countdown">05:00</span>
            </div>
            <div id="otp-error" class="error-message"></div>
            <div class="popup-footer">
                <button id="resend-otp-btn" class="popup-btn popup-btn-secondary" disabled>
                    Resend OTP (<span id="resend-countdown">60</span>s)
                </button>
                <button id="verify-otp-btn" class="popup-btn popup-btn-primary" disabled>Verify OTP</button>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}

<!-- Change the script tag to load directly from CDN -->
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script>
// Global variables for QR scanning
let videoStream = null;
let scanning = false;
let lastScanned = '';
let lastScannedTime = 0;
const SCAN_DELAY = 500; // ms
let debugMode = false;

// Initialize UI elements and set up event listeners
function initializeUI() {
    debugLog('Initializing UI elements...');
    
    // Initialize manual QR form
    const manualQRForm = document.getElementById('manual-qr-form');
    if (manualQRForm) {
        manualQRForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const qrInput = document.getElementById('manual-qr-input');
            if (qrInput && qrInput.value.trim()) {
                handleQRScan(qrInput.value.trim());
            }
        });
    }

    // Initialize camera buttons
    const startButton = document.getElementById('start-scanning-btn');
    const stopButton = document.getElementById('stop-scanning-btn');
    
    if (startButton) {
        startButton.disabled = false; // Enable by default since we don't need to wait for library
    }
    
    if (stopButton) {
        stopButton.style.display = 'none';
    }

    // Initialize debug mode
    const debugInfo = document.getElementById('debug-info');
    const toggleDebugButton = document.getElementById('toggle-debug');
    
    if (debugInfo && toggleDebugButton) {
        debugInfo.style.display = debugMode ? 'block' : 'none';
        toggleDebugButton.textContent = debugMode ? 'Hide Debug' : 'Show Debug';
    }

    debugLog('UI initialization completed');
}

// Force HTTPS only in production environments
function redirectToHttps() {
    const currentProtocol = window.location.protocol;
    const hostname = window.location.hostname;
    
    // Check if we're in a development environment
    const isDevelopment = hostname === 'localhost' || 
                         hostname === '127.0.0.1' ||
                         hostname.includes('ngrok-free.app');

    debugLog(`Current environment - Protocol: ${currentProtocol}, Hostname: ${hostname}, isDevelopment: ${isDevelopment}`);

    if (isDevelopment) {
        // Force HTTP in development
        if (currentProtocol === 'https:') {
            debugLog('Redirecting to HTTP for development');
            window.location.href = 'http:' + window.location.href.substring(currentProtocol.length);
        }
    } else {
        // Force HTTPS in production
        if (currentProtocol !== 'https:') {
            debugLog('Redirecting to HTTPS for production');
            window.location.href = 'https:' + window.location.href.substring(currentProtocol.length);
        }
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    debugLog('Page loaded, starting initialization...');
    
    // Check if HTTPS is needed and redirect if necessary
    redirectToHttps();
    
    // Enable debug mode by default during troubleshooting
    debugMode = true;
    const debugInfoElement = document.getElementById('debug-info');
    const toggleDebugButton = document.getElementById('toggle-debug');
    
    if (debugInfoElement) {
        debugInfoElement.style.display = 'block';
    }
    
    if (toggleDebugButton) {
        toggleDebugButton.textContent = 'Hide Debug';
    }
    
    debugLog('Debug mode enabled by default');
    
    // Set up event listeners
    document.getElementById('toggle-debug').addEventListener('click', toggleDebug);
    
    // Add camera button listeners
    const startButton = document.getElementById('start-scanning-btn');
    const stopButton = document.getElementById('stop-scanning-btn');
    
    if (startButton) {
        startButton.addEventListener('click', startScanner);
    }
    
    if (stopButton) {
        stopButton.addEventListener('click', stopScanner);
    }
    
    // Initialize UI elements
    initializeUI();
    
    // Check if jsQR is loaded
    if (typeof jsQR === 'undefined') {
        showError('QR scanner library failed to load. Please refresh the page.');
        debugLog('jsQR library not found');
    } else {
        debugLog('jsQR library loaded successfully');
        updateLibraryStatus('success', 'QR Code scanner ready');
    }
});

// Debug logging function
function debugLog(message) {
    console.log(message);
    if (debugMode) {
        const debugDiv = document.getElementById('debug-log');
        if (debugDiv) {
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }
    }
}

// Toggle debug mode
function toggleDebug() {
    debugMode = !debugMode;
    const debugInfo = document.getElementById('debug-info');
    const toggleBtn = document.getElementById('toggle-debug');
    
    if (debugMode) {
        debugInfo.style.display = 'block';
        toggleBtn.textContent = 'Hide Debug';
        debugLog('Debug mode enabled');
    } else {
        debugInfo.style.display = 'none';
        toggleBtn.textContent = 'Show Debug';
    }
}

// Update library status display with improved styling
function updateLibraryStatus(status, message) {
    const statusEl = document.getElementById('library-status');
    if (!statusEl) return;
    
    // Remove all status classes
    statusEl.classList.remove('loading', 'success', 'error');
    // Add new status class
    statusEl.classList.add(status);
    
    // Update content with icon
    let icon = '';
    switch (status) {
        case 'loading':
            icon = '<div class="loading-spinner"></div>';
            break;
        case 'success':
            icon = '✅';
            break;
        case 'error':
            icon = '❌';
            break;
    }
    
    statusEl.innerHTML = `${icon} ${message}`;
    
    // Hide success message after delay
    if (status === 'success') {
        setTimeout(() => {
            statusEl.style.display = 'none';
        }, 3000);
    } else {
        statusEl.style.display = 'block';
    }
}

// Check browser compatibility
function checkBrowserCompatibility() {
    debugLog('Checking browser compatibility...');
    
    const hostname = window.location.hostname;
    const protocol = window.location.protocol;
    const isDevelopment = hostname === 'localhost' || 
                         hostname === '127.0.0.1' ||
                         hostname.includes('ngrok-free.app');
    
    debugLog(`Compatibility check - Protocol: ${protocol}, Hostname: ${hostname}, isDevelopment: ${isDevelopment}`);
    
    // Check if required APIs are available
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        debugLog('getUserMedia not supported');
        return { compatible: false, reason: 'Camera API not supported in this browser' };
    }
    
    // In development, allow HTTP
    if (isDevelopment && protocol === 'http:') {
        debugLog('Development environment detected, allowing HTTP');
        return { compatible: true };
    }
    
    // In production, require HTTPS
    if (!isDevelopment && !window.isSecureContext) {
        debugLog('Production environment requires HTTPS');
        return { compatible: false, reason: 'Secure context (HTTPS) required for camera access' };
    }
    
    debugLog('Browser compatibility check passed');
    return { compatible: true };
}

// Show error function
function showError(message) {
    const errorSection = document.getElementById('error-section');
    const errorMessage = document.getElementById('error-message');
    errorMessage.textContent = message;
    errorSection.style.display = 'block';
    
    // Also show in camera status
    showCameraStatus(message, 'error');
    
    setTimeout(() => {
        errorSection.style.display = 'none';
    }, 8000);
}

function showCameraStatus(message, type = 'info') {
    const cameraStatus = document.getElementById('camera-status');
    if (cameraStatus) {
        cameraStatus.style.display = 'block';
        if (type === 'success') {
            cameraStatus.style.background = '#e8f5e8';
            cameraStatus.style.color = '#2e7d32';
            cameraStatus.style.border = '1px solid #4caf50';
            cameraStatus.textContent = `✅ ${message}`;
        } else if (type === 'error') {
            cameraStatus.style.background = '#ffebee';
            cameraStatus.style.color = '#c62828';
            cameraStatus.style.border = '1px solid #f44336';
            cameraStatus.textContent = `❌ ${message}`;
        } else {
            cameraStatus.style.background = '#e3f2fd';
            cameraStatus.style.color = '#1976d2';
            cameraStatus.style.border = '1px solid #2196f3';
            cameraStatus.textContent = `ℹ️ ${message}`;
        }
    }
}

function startScanner() {
    debugLog('Starting scanner...');
    const startButton = document.getElementById('start-scanning-btn');
    const stopButton = document.getElementById('stop-scanning-btn');
    const scannerContainer = document.getElementById('scanner-container');
    const spinner = startButton.querySelector('.loading-spinner');
    
    // Show loading state
    startButton.disabled = true;
    spinner.style.display = 'inline-block';
    startButton.textContent = ' Starting Camera...';
    startButton.prepend(spinner);
    
    // Start the camera
    startCameraInternal()
        .then(() => {
            // Update UI
            scannerContainer.style.display = 'block';
            startButton.style.display = 'none';
            stopButton.style.display = 'block';
            updateLibraryStatus('success', 'Scanner started');
        })
        .catch(error => {
            debugLog('Failed to start scanner:', error);
            showError(error.message || 'Failed to start camera');
            resetStartButton();
        });
}

function scanQRCode() {
    if (!scanning) return;
    
    debugLog('Starting QR code scanning...');
    const video = document.getElementById('qr-video');
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');

    function scan() {
        if (!scanning) {
            debugLog('Scanning stopped');
            return;
        }

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            
            try {
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    debugLog('QR Code found:', code.data);
                    const now = Date.now();
                    if (code.data !== lastScanned || (now - lastScannedTime) > SCAN_DELAY) {
                        lastScanned = code.data;
                        lastScannedTime = now;
                        handleQRScan(code.data);
                    }
                }
            } catch (error) {
                debugLog('Error processing frame:', error);
            }
        }
        requestAnimationFrame(scan);
    }

    scan();
    debugLog('QR code scanning loop started');
}

function startCameraInternal() {
    return new Promise((resolve, reject) => {
        debugLog('Starting camera initialization...');
        
        // Check browser compatibility first
        const compatCheck = checkBrowserCompatibility();
        if (!compatCheck.compatible) {
            debugLog(`Camera initialization failed: ${compatCheck.reason}`);
            reject(new Error(compatCheck.reason));
            return;
        }

        const video = document.getElementById('qr-video');
        const scannerContainer = document.getElementById('scanner-container');
        
        if (!video || !scannerContainer) {
            debugLog('Required video elements not found');
            reject(new Error('Required video elements not found'));
            return;
        }

        debugLog('Requesting camera access...');
        navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: { ideal: "environment" },
                width: { min: 640, ideal: 1280, max: 1920 },
                height: { min: 480, ideal: 720, max: 1080 },
                frameRate: { min: 10, ideal: 15, max: 30 }
            }
        })
        .then(stream => {
            debugLog('Camera access granted');
            videoStream = stream;
            video.srcObject = stream;
            scannerContainer.style.display = 'block'; // Show the video container
            return video.play();
        })
        .then(() => {
            debugLog('Video playback started');
            scanning = true;
            scanQRCode();
            resolve();
        })
        .catch(err => {
            debugLog(`Camera error: ${err.message}`);
            console.error('Camera error:', err);
            reject(new Error(`Camera error: ${err.message}`));
        });
    });
}

function stopScanner() {
    debugLog('Stopping scanner...');
    scanning = false;
    
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
    }
    
    const video = document.getElementById('qr-video');
    const scannerContainer = document.getElementById('scanner-container');
    const startButton = document.getElementById('start-scanning-btn');
    const stopButton = document.getElementById('stop-scanning-btn');
    
    if (video) {
        video.srcObject = null;
    }
    
    // Reset UI
    scannerContainer.style.display = 'none';
    startButton.style.display = 'block';
    stopButton.style.display = 'none';
    resetStartButton();
    
    updateLibraryStatus('success', 'Scanner stopped');
}

function resetStartButton() {
    const startButton = document.getElementById('start-scanning-btn');
    const spinner = startButton.querySelector('.loading-spinner');
    
    startButton.textContent = 'Launch Camera';
    startButton.disabled = false;
    
    if (spinner) {
        spinner.style.display = 'none';
    }
}

function startQRScanner() {
    debugLog('Initializing QR scanner...');
    const config = { 
        fps: 10, // Reduced from 30 to save resources
        qrbox: function(viewfinderWidth, viewfinderHeight) {
            let minEdgePercentage = 0.6; // Slightly smaller scan area for faster processing
            let minEdgeSize = Math.min(viewfinderWidth, viewfinderHeight);
            let qrboxSize = Math.floor(minEdgeSize * minEdgePercentage);
            return {
                width: qrboxSize,
                height: qrboxSize
            };
        },
        aspectRatio: 1.0,
        disableFlip: true, // Disable flip to improve performance
        formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE],
        videoConstraints: {
            facingMode: { ideal: "environment" },
            width: { min: 640, ideal: 1280, max: 1920 }, // Reduced resolution
            height: { min: 480, ideal: 720, max: 1080 }, // Reduced resolution
            frameRate: { min: 10, ideal: 15, max: 30 }, // Reduced frame rate
            // Removed advanced constraints that might slow down initialization
        },
        experimentalFeatures: {
            useBarCodeDetectorIfSupported: true
        }
    };

    return new Promise((resolve, reject) => {
        try {
            // Clean up existing scanner
            // No longer need to manage html5QrcodeScanner as it's removed
            // if (html5QrcodeScanner) {
            //     try {
            //         html5QrcodeScanner.clear()
            //             .then(() => {
            //                 initializeNewScanner();
            //             })
            //             .catch(err => {
            //                 debugLog('Error clearing existing scanner: ' + err);
            //                 initializeNewScanner();
            //             });
            //     } catch (e) {
            //         debugLog('Failed to clear existing scanner: ' + e);
            //         initializeNewScanner();
            //     }
            // } else {
                initializeNewScanner();
            // }

            function initializeNewScanner() {
                // Clear and prepare container
                const qrContainer = document.getElementById("qr-reader");
                if (!qrContainer) {
                    throw new Error('QR reader container not found');
                }
                qrContainer.innerHTML = '';

                // Create new scanner instance with verbose mode off
                // No longer need to use Html5QrcodeScanner as it's removed
                // html5QrcodeScanner = new Html5QrcodeScanner(
                //     "qr-reader",
                //     config,
                //     false // verbose mode off for better performance
                // );

                debugLog('jsQR instance created');

                // Simplified success callback with shorter debounce
                let lastScanned = '';
                let lastScannedTime = 0;
                const SCAN_DELAY = 500; // Reduced from 1000ms to 500ms

                const debouncedSuccess = (decodedText, decodedResult) => {
                    const now = Date.now();
                    if (decodedText !== lastScanned || (now - lastScannedTime) > SCAN_DELAY) {
                        lastScanned = decodedText;
                        lastScannedTime = now;
                        onScanSuccess(decodedText, decodedResult);
                    }
                };

                // Start the scanner with optimized settings
                // No longer need to use Html5QrcodeScanner as it's removed
                // html5QrcodeScanner.render(debouncedSuccess, onScanFailure);

                // Add visual scanning indicator
                const scanIndicator = document.createElement('div');
                scanIndicator.className = 'scan-indicator';
                qrContainer.appendChild(scanIndicator);

                resolve();
            }
        } catch (err) {
            debugLog(`Failed to create jsQR instance: ${err.message}`);
            showError(`Scanner initialization failed: ${err.message}`);
            reject(err);
        }
    });
}

function stopCamera() {
    debugLog('Stopping camera...');
    
    // No longer need to manage html5QrcodeScanner as it's removed
    // if (html5QrcodeScanner) {
    //     try {
    //         html5QrcodeScanner.clear()
    //             .then(() => {
    //                 debugLog('Camera stopped successfully');
    //                 resetCameraUI();
    //             })
    //             .catch(err => {
    //                 debugLog(`Error stopping camera: ${err.message}`);
    //                 console.error('Error stopping camera:', err);
    //                 resetCameraUI(); // Still reset UI even if there's an error
    //             });
    //     } catch (err) {
    //         debugLog(`Error stopping camera: ${err.message}`);
    //         console.error('Error stopping camera:', err);
    //         resetCameraUI(); // Still reset UI even if there's an error
    //     }
    // } else {
        debugLog('No scanner instance to stop');
        resetCameraUI();
    // }
}

function resetCameraUI() {
    // No longer need to manage html5QrcodeScanner as it's removed
    // html5QrcodeScanner = null;
    
    const placeholder = document.getElementById('camera-placeholder');
    const startButton = document.getElementById('start-scanning-btn');
    const stopButton = document.getElementById('stop-scanning-btn');
    const qrReader = document.getElementById('qr-reader');
    
    if (placeholder) placeholder.style.display = 'block';
    if (startButton) startButton.style.display = 'inline-block';
    if (stopButton) stopButton.style.display = 'none';
    if (qrReader) qrReader.innerHTML = '';
    
    resetStartButton();
    
    // Hide camera status
    const cameraStatus = document.getElementById('camera-status');
    if (cameraStatus) cameraStatus.style.display = 'none';
}

// Function to handle QR scan results
function handleQRScan(qrData) {
    debugLog('Processing QR scan result:', qrData);
    
    try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Create form data instead of JSON
        const formData = new FormData();
        formData.append('qr_data', qrData);
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        // Send QR data to server
        fetch('/auth/scan-qr/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Accept': 'application/json'
            },
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('text/html')) {
                    throw new Error('Server returned an error page. Please refresh and try again.');
                }
                throw new Error(`Server error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                currentQRData = data;
                PopupManager.showView('purchase', {
                    purchases: data.purchases || []
                });
            } else {
                showError(data.error || 'Failed to process QR code');
                restartScanner();
            }
        })
        .catch(error => {
            console.error('Error processing QR code:', error);
            showError(error.message || 'Failed to process QR code. Please try again.');
            restartScanner();
        });
    } catch (error) {
        console.error('Error handling QR scan:', error);
        showError('An error occurred while processing the QR code.');
        restartScanner();
    }
}

// Helper function to restart scanner
function restartScanner() {
    // No longer need to manage html5QrcodeScanner as it's removed
    // if (html5QrcodeScanner) {
    //     // First try to resume if only paused
    //     try {
    //         html5QrcodeScanner.resume()
    //             .catch(() => {
    //                 // If resume fails, do a full restart
    //                 startQRScanner().catch(err => {
    //                     debugLog('Failed to restart scanner: ' + err);
    //                 });
    //             });
    //     } catch (err) {
    //         // If resume throws, do a full restart
    //         startQRScanner().catch(err => {
    //             debugLog('Failed to restart scanner: ' + err);
    //         });
    //     }
    // } else {
        // If no scanner instance, start fresh
        startQRScanner().catch(err => {
            debugLog('Failed to restart scanner: ' + err);
        });
    // }
}

// Modify onScanSuccess to use the new restart mechanism
function onScanSuccess(decodedText, decodedResult) {
    debugLog(`QR Code detected: ${decodedText}`);
    
    // Play a success sound
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        gainNode.gain.value = 0.3;
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.2);
    } catch (e) {
        debugLog("Could not play sound: " + e.message);
    }
    
    showCameraStatus('QR Code detected! Processing...', 'success');
    
    // Pause scanner while processing
    // No longer need to manage html5QrcodeScanner as it's removed
    // if (html5QrcodeScanner) {
    //     try {
    //         html5QrcodeScanner.pause();
    //     } catch (err) {
    //         debugLog(`Error pausing scanner: ${err.message}`);
    //     }
    // }
    
    // Process the QR code
    handleQRScan(decodedText);
}

// Modify onScanFailure to reduce console noise
function onScanFailure(error) {
    // Only log significant errors, ignore common scan failures
    if (debugMode && error && 
        !error.includes('QR code parse error') && 
        !error.includes('No QR code found')) {
        debugLog(`Scan attempt: ${error}`);
    }
}

// Popup Management System
const PopupManager = {
    currentView: null,
    popup: document.getElementById('dynamic-popup'),
    views: {
        purchase: document.getElementById('purchase-view'),
        auth: document.getElementById('auth-view'),
        otp: document.getElementById('otp-view')
    },

    showView: function(viewName, data = {}) {
        // Hide all views first
        Object.values(this.views).forEach(view => view.style.display = 'none');
        
        // Show the requested view
        const view = this.views[viewName];
        if (view) {
            view.style.display = 'block';
            this.currentView = viewName;
            this.popup.style.display = 'block';
            
            // Initialize view-specific content
            switch(viewName) {
                case 'purchase':
                    this.initializePurchaseView(data);
                    break;
                case 'auth':
                    this.initializeAuthView(data);
                    break;
                case 'otp':
                    this.initializeOTPView(data);
                    break;
            }
        }
    },

    close: function() {
        this.popup.style.display = 'none';
        this.currentView = null;
        // Reset forms and clear data
        this.resetForms();
        
        // Restart scanner after popup closes
        restartScanner();
    },

    resetForms: function() {
        // Reset purchase selection
        const purchaseList = document.getElementById('purchase-list');
        if (purchaseList) purchaseList.innerHTML = '';
        document.getElementById('confirm-purchase-btn').disabled = true;
        
        // Reset auth form
        const authForm = document.getElementById('auth-view');
        if (authForm) {
            authForm.querySelector('#auth-username').value = '';
            authForm.querySelector('#auth-password').value = '';
            authForm.querySelector('#auth-error').style.display = 'none';
        }
        
        // Reset OTP form
        const otpInputs = document.querySelectorAll('.otp-input');
        otpInputs.forEach(input => input.value = '');
        document.getElementById('verify-otp-btn').disabled = true;
        document.getElementById('otp-error').style.display = 'none';
    },

    initializePurchaseView: function(data) {
        const purchaseList = document.getElementById('purchase-list');
        const loadingElement = document.getElementById('purchase-loading');
        const emptyElement = document.getElementById('purchase-empty');
        
        loadingElement.style.display = 'block';
        emptyElement.style.display = 'none';
        purchaseList.innerHTML = '';
        
        if (data.purchases && data.purchases.length > 0) {
            loadingElement.style.display = 'none';
            data.purchases.forEach(purchase => {
                const purchaseElement = document.createElement('div');
                purchaseElement.className = 'purchase-item';
                purchaseElement.dataset.purchaseId = purchase.id;
                purchaseElement.innerHTML = `
                    <strong>${purchase.product_name}</strong><br>
                    Order ID: ${purchase.order_id}<br>
                    Quantity: ${purchase.quantity}<br>
                    Price: ${purchase.price}<br>
                    Vendor: ${purchase.vendor_name}
                `;
                purchaseElement.addEventListener('click', () => this.selectPurchase(purchase.id));
                purchaseList.appendChild(purchaseElement);
            });
        } else {
            loadingElement.style.display = 'none';
            emptyElement.style.display = 'block';
        }
    },

    selectPurchase: function(purchaseId) {
        const items = document.querySelectorAll('.purchase-item');
        items.forEach(item => item.classList.remove('selected'));
        
        const selectedItem = document.querySelector(`.purchase-item[data-purchase-id="${purchaseId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('selected');
            document.getElementById('confirm-purchase-btn').disabled = false;
            selectedPurchaseId = purchaseId;
        }
    },

    initializeAuthView: function(data) {
        const usernameInput = document.getElementById('auth-username');
        if (data.username) {
            usernameInput.value = data.username;
            usernameInput.disabled = true;
        } else {
            usernameInput.disabled = false;
        }
        document.getElementById('auth-password').focus();
    },

    initializeOTPView: function(data) {
        if (data.email) {
            document.getElementById('buyer-email').textContent = data.email;
        }
        
        // Focus first OTP input
        const firstInput = document.querySelector('.otp-input');
        if (firstInput) firstInput.focus();
        
        // Start timers
        this.startOTPTimer();
        this.startResendTimer();
    },

    startOTPTimer: function() {
        let timeLeft = 300; // 5 minutes in seconds
        const timerDisplay = document.getElementById('timer-countdown');
        
        if (otpTimer) clearInterval(otpTimer);
        
        otpTimer = setInterval(() => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(otpTimer);
                this.showView('auth'); // Go back to auth view when OTP expires
            }
            timeLeft--;
        }, 1000);
    },

    startResendTimer: function() {
        let timeLeft = 60;
        const resendButton = document.getElementById('resend-otp-btn');
        const countdownDisplay = document.getElementById('resend-countdown');
        
        if (resendTimer) clearInterval(resendTimer);
        
        resendButton.disabled = true;
        
        resendTimer = setInterval(() => {
            countdownDisplay.textContent = timeLeft;
            
            if (timeLeft <= 0) {
                clearInterval(resendTimer);
                resendButton.disabled = false;
                countdownDisplay.textContent = '60';
            }
            timeLeft--;
        }, 1000);
    }
};

// Event Listeners for Popup
document.addEventListener('DOMContentLoaded', function() {
    // Close button handlers
    document.querySelectorAll('[data-action="close"]').forEach(button => {
        button.addEventListener('click', () => PopupManager.close());
    });
    
    // Verify credentials button
    document.getElementById('verify-credentials-btn').addEventListener('click', () => {
        const username = document.getElementById('auth-username').value;
        const password = document.getElementById('auth-password').value;
        
        // Add your verification logic here
        verifyCredentials(username, password);
    });
    
    // Confirm purchase button
    document.getElementById('confirm-purchase-btn').addEventListener('click', () => {
        if (selectedPurchaseId) {
            PopupManager.showView('auth', {
                username: currentPurchaser
            });
        }
    });
    
    // Resend OTP button
    document.getElementById('resend-otp-btn').addEventListener('click', () => {
        // Add your resend OTP logic here
        requestNewOTP();
        PopupManager.startResendTimer();
    });
    
    // Verify OTP button
    document.getElementById('verify-otp-btn').addEventListener('click', () => {
        const otpValue = Array.from(otpInputs).map(input => input.value).join('');
        verifyOTP(otpValue);
    });
});

// Add these functions to your existing code
function verifyCredentials(username, password) {
    // Example implementation
    fetch('/auth/verify-credentials/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ username, password, purchase_id: selectedPurchaseId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            PopupManager.showView('otp', {
                email: data.email
            });
        } else {
            const errorElement = document.getElementById('auth-error');
            errorElement.textContent = data.error || 'Invalid credentials';
            errorElement.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const errorElement = document.getElementById('auth-error');
        errorElement.textContent = 'An error occurred. Please try again.';
        errorElement.style.display = 'block';
    });
}

function verifyOTP(otp) {
    // Example implementation
    fetch('/auth/verify-otp/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ 
            otp,
            purchase_id: selectedPurchaseId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            PopupManager.close();
            // Show success message and redirect
            window.location.href = '/auth/koraquest-dashboard/';
        } else {
            const errorElement = document.getElementById('otp-error');
            errorElement.textContent = data.error || 'Invalid OTP';
            errorElement.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const errorElement = document.getElementById('otp-error');
        errorElement.textContent = 'An error occurred. Please try again.';
        errorElement.style.display = 'block';
    });
}

function requestNewOTP() {
    // Example implementation
    fetch('/auth/request-otp/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ purchase_id: selectedPurchaseId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // OTP sent successfully, start the timer
            PopupManager.startOTPTimer();
        } else {
            const errorElement = document.getElementById('otp-error');
            errorElement.textContent = data.error || 'Failed to send OTP';
            errorElement.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const errorElement = document.getElementById('otp-error');
        errorElement.textContent = 'An error occurred. Please try again.';
        errorElement.style.display = 'block';
    });
}

// ... rest of your existing JavaScript code ...
</script>
{% endblock %}
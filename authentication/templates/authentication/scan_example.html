{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan QR Code</title>
    <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1975f5, #63a4ff);
            color: #333;
            padding: 20px;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .wrapper {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
            position: relative;
        }

        h1 {
            margin-bottom: 2rem;
            color: #333;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px;
        }

        #scan-qr-btn {
            background: #007bff;
            color: white;
        }

        #scan-qr-btn:hover {
            background: #0056b3;
        }

        #stop-scanning-btn {
            background: #dc3545;
            color: white;
            display: none;
        }

        #stop-scanning-btn:hover {
            background: #c82333;
        }

        .back-to-d {
            background: #6c757d;
            color: white;
        }

        .back-to-d:hover {
            background: #5a6268;
        }

        #scanner-container {
            margin: 20px 0;
            position: relative;
            display: none;
        }

        #qr-video {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
        }

        #qr-status-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .status-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 300px;
        }

        .status-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .scan-region-highlight {
            border: 2px solid #007bff;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border-radius: 8px;
        }

        .scan-region-highlight::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: #00ff00;
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% { transform: translateY(0); }
            50% { transform: translateY(200px); }
            100% { transform: translateY(0); }
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <h1>QR Code Scanner</h1>
        <button id="scan-qr-btn">Start Scanning</button>
        <a href="{% url 'admin_dashboard' %}"><button class="back-to-d">Back To Dashboard</button></a>
        <div id="scanner-container">
            <video id="qr-video"></video>
            <div class="scan-region-highlight"></div>
            <button id="stop-scanning-btn">Stop Scanning</button>
        </div>
    </div>

    <script>
        const scanButton = document.getElementById('scan-qr-btn');
        const stopButton = document.getElementById('stop-scanning-btn');
        const scannerContainer = document.getElementById('scanner-container');
        const videoElement = document.getElementById('qr-video');

        let videoStream;
        let scanning = false;
        let lastScanned = '';
        let lastScannedTime = 0;
        const SCAN_DELAY = 500; // Debounce delay in milliseconds

        // Event listeners
        scanButton.addEventListener('click', startScanner);
        stopButton.addEventListener('click', stopScanner);

        function startScanner() {
            scanButton.style.display = 'none';
            stopButton.style.display = 'inline-block';
            scannerContainer.style.display = 'block';

            // Request camera with optimized constraints
            navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: { ideal: "environment" },
                    width: { min: 640, ideal: 1280, max: 1920 },
                    height: { min: 480, ideal: 720, max: 1080 },
                    frameRate: { min: 10, ideal: 15, max: 30 }
                }
            })
            .then(stream => {
                videoElement.srcObject = stream;
                videoStream = stream;
                videoElement.play();
                scanning = true;
                scanQRCode();
            })
            .catch(err => {
                console.error("Camera access error:", err);
                createStatusOverlay('error', 'Failed to access camera. Please check permissions.');
                resetUI();
            });
        }

        function stopScanner() {
            scanning = false;
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            resetUI();
        }

        function resetUI() {
            scanButton.style.display = 'inline-block';
            stopButton.style.display = 'none';
            scannerContainer.style.display = 'none';
            videoElement.srcObject = null;
        }

        function scanQRCode() {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            function scan() {
                if (!scanning) return;

                if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                    canvas.height = videoElement.videoHeight;
                    canvas.width = videoElement.videoWidth;
                    context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, canvas.width, canvas.height, {
                        inversionAttempts: "dontInvert"
                    });

                    if (code) {
                        const now = Date.now();
                        if (code.data !== lastScanned || (now - lastScannedTime) > SCAN_DELAY) {
                            lastScanned = code.data;
                            lastScannedTime = now;
                            handleQRCode(code.data);
                        }
                    }
                }
                requestAnimationFrame(scan);
            }

            scan();
        }

        function handleQRCode(qrData) {
            // Play success sound
            playSuccessBeep();
            
            // Extract UUID if QR data is a URL
            try {
                const urlObj = new URL(qrData);
                qrData = urlObj.pathname.split('/').filter(Boolean).pop();
            } catch (e) {
                // If parsing URL fails, use raw data with cleanup
                qrData = qrData.replace(/^\/+|\/+RWF/g, '');
            }

            // Validate UUID format
            const uuidPattern = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}RWF/;
            if (!uuidPattern.test(qrData)) {
                createStatusOverlay('error', 'Invalid QR code format');
                return;
            }

            // Send to server
            const csrfToken = '{{ csrf_token }}';
            fetch(`/scan/${qrData}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ qr_code_id: qrData })
            })
            .then(response => response.json())
            .then(data => {
                let status = 'success';
                if (data.message.includes('already been marked')) {
                    status = 'warning';
                } else if (data.message.includes('Invalid')) {
                    status = 'error';
                }
                createStatusOverlay(status, data.message);
                stopScanner();
            })
            .catch(error => {
                console.error('Error:', error);
                createStatusOverlay('error', 'Failed to process QR code');
            });
        }

        function createStatusOverlay(status, message) {
            const existingOverlay = document.getElementById('qr-status-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }

            const overlay = document.createElement('div');
            overlay.id = 'qr-status-overlay';

            const content = document.createElement('div');
            content.className = 'status-content';

            const icon = document.createElement('div');
            icon.className = 'status-icon';
            icon.innerHTML = getStatusIcon(status);

            const messageEl = document.createElement('p');
            messageEl.textContent = message;

            content.appendChild(icon);
            content.appendChild(messageEl);
            overlay.appendChild(content);
            document.body.appendChild(overlay);

            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 300);
            }, 3000);
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'success': return '✅';
                case 'warning': return '⚠️';
                case 'error': return '❌';
                default: return 'ℹ️';
            }
        }

        function playSuccessBeep() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                gainNode.gain.value = 0.3;
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log("Could not play sound:", e);
            }
        }

        // Force HTTPS for camera access
        if (location.protocol !== 'https:' && 
            location.hostname !== 'localhost' && 
            !location.hostname.match(/^127\.\d+\.\d+\.\d+RWF/)) {
            location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
        }
    </script>
</body>
</html>